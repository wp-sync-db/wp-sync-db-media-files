var wpmdb=wpmdb||{};wpmdb.mediaFiles={remote_media_files_unavailable:!1},function(a,b){function c(g){if(0===Object.size(g.files_to_migrate))return 0===g.total_size?f(0,0,0):e(g),delete g.files_to_migrate,delete g.total_size,b.common.next_step_in_migration={fn:b.functions.determine_media_to_migrate_recursive,args:[g]},void b.functions.execute_next_step();var h=[],i=0,j=0;return a.each(g.files_to_migrate,function(a,c){if("push"===wpmdb_migration_type()&&c>l){var d=wpmdbmf_strings.file_too_large+" "+a+" (#124mf)<br>";b.common.non_fatal_errors+=d}else if(h.length){if(i+c>g.bottleneck||j>=b.mediaFiles.remote_connection_data.media_files_max_file_uploads)return!1;h.push(a),i+=c}else h.push(a),i+=c;delete g.files_to_migrate[a],++g.media_progress_image_number,++j}),b.common.migration_error?void b.functions.migration_complete_events():h.length?void a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_migrate_media",migration_state_id:b.migration_state_id,file_chunk:h,nonce:wpmdb_data.nonces.migrate_media},error:function(c,d,e){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text",".progress-wrapper-primary").html(wpmdbGetAjaxErrors(wpmdbmf_strings.problem_migrating_media,"(#102mf)",c.responseText,c)),a(".progress-text",".progress-wrapper-primary").addClass("migration-error"),console.log(c),console.log(d),console.log(e),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(f){var h=f;return(f=wpmdb_parse_json(a.trim(f)))?"undefined"!=typeof f.wpmdb_error&&1===f.wpmdb_error?void d(f.body):("undefined"!=typeof f.wpmdb_non_fatal_error&&1===f.wpmdb_non_fatal_error&&(b.common.non_fatal_errors+=f.body),g.media_progress+=i,e(g),b.common.next_step_in_migration={fn:c,args:[g]},void b.functions.execute_next_step()):void d(h)}}):(e(g),b.common.next_step_in_migration={fn:c,args:[g]},void b.functions.execute_next_step())}function d(c){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text",".progress-wrapper-primary").html(wpmdbGetAjaxErrors("","",c)),a(".progress-text",".progress-wrapper-primary").addClass("migration-error"),a(".progress-wrapper-secondary").fadeOut(),b.common.migration_error=!0,b.functions.migration_complete_events()}function e(a){var b=100*a.media_progress/a.total_size,c=b/100*a.total_files;f(b,Math.round(c),a.total_files)}function f(b,c,d){var e=Math.floor(b),f="migrate_media_files_"+wpmdb_migration_type();a(".progress-text",".progress-wrapper-secondary").html(e+"% - "+wpmdbmf_strings[f]);var g="%";0===b&&(g="px"),a(".progress-bar",".progress-wrapper-secondary").width(b+g);var h="";d>=0&&(h+="<span>"+wpmdbmf_strings.media_files+' (<span class="">'+wpmdb_add_commas(c)+"</span> / "+wpmdb_add_commas(d)+")</span>"),a(".progress-tables",".progress-wrapper-secondary").html('<div title="" style="width: 100%;" class="progress-chunk media_files">'+h+"</div>")}function g(){return"1"===a("#media-files").attr("data-available")&&a("#media-files").is(":checked")?!0:!1}function h(b,c){return"savefile"!==wpmdb_migration_type()&&a("#media-files").is(":checked")&&"true"===wpmdb_data.is_multisite&&n.is(":checked")&&null===a("#mf-selected-subsites").val()&&(alert(wpmdbmf_strings.please_select_a_subsite),b=!1),b}function i(){var b=a('input[name="media_migration_option"][value="compare-remove"]');a(b).is(":checked")?a(".compare-remove-warning").show():a(".compare-remove-warning").hide()}function j(){var a={};return"pull"===wpmdb_migration_type()?"undefined"!=typeof b.mediaFiles.remote_connection_data&&"undefined"!=typeof b.mediaFiles.remote_connection_data.subsites&&(a=b.mediaFiles.remote_connection_data.subsites):void 0!==wpmdb_data.subsites&&(a=wpmdb_data.subsites),a}function k(){var c=a(".mf-selected-subsites-tables-differ"),d=a("#mf-selected-subsites").val(),e=a.wpmdb.apply_filters("wpmdb_get_tables_to_migrate",null,null);if("true"===wpmdb_data.is_multisite&&n.is(":checked")&&void 0!==d&&null!==d&&void 0!==e&&null!==e&&0<e.length){var f=a.wpmdb.apply_filters("wpmdb_get_table_prefix",null,null),g=!1;a.each(e,function(c,e){if(b.table_is(f,"posts",e)||b.table_is(f,"postmeta",e)){var h=b.subsite_for_table(f,e);if(0>a.inArray(h.toString(),d))return g=!0,!1}}),g?c.show():c.hide()}else c.hide()}var l=0,m=a("#mf-select-subsites-section"),n=a("#mf-select-subsites");Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c};var o=function(){a("#media-files").attr("data-available","0"),a("#media-files").prop("checked",!1),a("#media-files").attr("disabled","disabled"),a(".media-files").addClass("disabled"),a(".media-files-options .expandable-content").hide()},p=function(c){var d=wpmdb_migration_type();if("savefile"===d)return void a(".media-files-options").hide();if(a(".media-files-options").show(),a(".media-files-push").hide(),c)return a(".media-files-options ul").hide(),a(".media-migration-unavailable").show(),void o();if("undefined"!=typeof b.mediaFiles.remote_connection_data&&wpmdb_data.media_files_version!==b.mediaFiles.remote_connection_data.media_files_version)return a(".media-files-remote-location").html(b.mediaFiles.remote_connection_data.url),a(".media-file-remote-version").html(b.mediaFiles.remote_connection_data.media_files_version),a(".media-files-different-plugin-version-notice").show(),void o();if("true"===wpmdb_data.is_multisite){var e=j(),f=a("#_mf-selected-subsites"),g=a("#mf-selected-subsites").val();"pull"===d&&0<Object.size(e)&&f.length&&(g=a.parseJSON(f.val()),f.remove()),b.multisite.update_multiselect("#mf-selected-subsites",e,g);var h=a.wpmdb.apply_filters("wpmdbmf_enable_select_subsites",!0);h?m.show():(n.prop("checked",!1),m.hide()),n.change(),k()}a(".media-files-options ul").show(),a(".media-migration-unavailable").hide(),a(".media-files-different-plugin-version-notice").hide(),a("#media-files").removeAttr("disabled"),a(".media-files").removeClass("disabled"),a("#media-files").attr("data-available","1")};b.functions.prepare_remove_all_files=function(){b.mediaFiles.connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n");var c=a('input[name="media_migration_option"]:checked').val();if(a(".progress-tables").empty(),a(".progress-tables-hover-boxes").empty(),a(".progress-bar").width("0px"),"entire"===c){var d="removing_all_files_"+wpmdb_migration_type();a(".progress-text",".progress-wrapper-primary").html(wpmdbmf_strings[d]);var e={};e.remove_files=1,e.compare=0,e.offset=0,e.next_step_in_migration=b.functions.prepare_determine_media,b.common.next_step_in_migration={fn:b.functions.remove_files_recursive,args:[e]},b.functions.execute_next_step()}else b.common.next_step_in_migration={fn:b.functions.prepare_determine_media},b.functions.execute_next_step()},b.functions.remove_files_recursive=function(c){if(0===c.remove_files)return void(!1!==c.next_step_in_migration?(b.common.next_step_in_migration={fn:c.next_step_in_migration},b.functions.execute_next_step()):wpmdb_call_next_hook());b.mediaFiles.connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n");var e=c;a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_remove_files_recursive",migration_state_id:b.migration_state_id,compare:c.compare,offset:c.offset,nonce:wpmdb_data.nonces.remove_files_recursive},error:function(c,d,e){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text").html(wpmdbGetAjaxErrors(wpmdbmf_strings.error_determining,"(#101mf)",c.responseText,c)),a(".progress-text").addClass("migration-error"),console.log(c),console.log(d),console.log(e),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(f){var g=f;return(c=wpmdb_parse_json(a.trim(f)))?"undefined"!=typeof c.wpmdb_error&&1===c.wpmdb_error?void d(c.body):("undefined"!=typeof c.wpmdb_non_fatal_error&&1===c.wpmdb_non_fatal_error&&(b.common.non_fatal_errors+=c.body),c.next_step_in_migration=e.next_step_in_migration,b.common.next_step_in_migration={fn:b.functions.remove_files_recursive,args:[c]},void b.functions.execute_next_step()):void d(g)}})},b.functions.prepare_determine_media=function(){b.mediaFiles.connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n"),l=0;var c=0,e=0,f=a('input[name="media_migration_option"]:checked').val();a(".progress-tables").empty(),a(".progress-tables").html('<div title="'+wpmdbmf_strings.media_files+'" style="width: 100%;" class="progress-chunk media_files"><span></div>'),a(".progress-text",".progress-wrapper-primary").html("0% - "+wpmdbmf_strings.determining),"compare-remove"===f&&(f="compare",c=1),"entire"===f&&(e=1);var g={};a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_prepare_determine_media",migration_state_id:b.migration_state_id,nonce:wpmdb_data.nonces.prepare_determine_media},error:function(c,d,e){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text").html(wpmdbGetAjaxErrors(wpmdbmf_strings.error_determining,"(#101mf)",c.responseText,c)),a(".progress-text").addClass("migration-error"),console.log(c),console.log(d),console.log(e),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(f){var h=f;return(g=wpmdb_parse_json(a.trim(f)))?"undefined"!=typeof g.wpmdb_error&&1===g.wpmdb_error?void d(g.body):(l=g.remote_max_upload_size,g.determine_progress=0,g.remove_local_media=c,g.copy_entire_media=e,a(".progress-tables").html('<div title="'+wpmdbmf_strings.media_attachments+'" style="width: 100%;" class="progress-chunk media_files"><span>'+wpmdbmf_strings.media_attachments+' (<span class="">0</span> / '+wpmdb_add_commas(g.attachment_count)+")</span></div>"),b.common.next_step_in_migration={fn:b.functions.determine_media_to_migrate_recursive,args:[g]},void b.functions.execute_next_step()):void d(h)}})},b.functions.determine_media_to_migrate_recursive=function(c){return c.determine_progress===c.attachment_count?(a(".progress-wrapper-secondary").hide(),a(".progress-bar").width("0px"),a(".progress-tables").empty(),b.common.next_step_in_migration={fn:b.functions.finalise_media_migration,args:[c]},void b.functions.execute_next_step()):(b.mediaFiles.connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n"),void a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_determine_media_to_migrate_recursive",migration_state_id:b.migration_state_id,determine_progress:c.determine_progress,attachment_count:c.attachment_count,remote_uploads_url:c.remote_uploads_url,remove_local_media:c.remove_local_media,copy_entire_media:c.copy_entire_media,blogs:c.blogs,attachment_batch_limit:c.attachment_batch_limit,nonce:wpmdb_data.nonces.determine_media_to_migrate_recursive},error:function(c,d,e){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text",".progress-wrapper-primary").html(wpmdbmf_strings.error_determining+" (#101mf)"),a(".progress-text",".progress-wrapper-primary").addClass("migration-error"),console.log(c),console.log(d),console.log(e),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(e){var f=e;if(e=wpmdb_parse_json(a.trim(e)),!e)return void d(f);if("undefined"!=typeof e.wpmdb_error&&1===e.wpmdb_error)return void d(e.body);c.blogs=e.blogs,c.determine_progress=e.determine_progress,c.total_size=e.total_size,c.files_to_migrate=e.files_to_migrate;var g=100*c.determine_progress/c.attachment_count,h=Math.floor(g);a(".progress-bar",".progress-wrapper-primary").width(g+"%"),a(".progress-text",".progress-wrapper-primary").html(h+"% - "+wpmdbmf_strings.determining),a(".progress-tables",".progress-wrapper-primary").html('<div title="'+wpmdbmf_strings.media_attachments+'" style="width: 100%;" class="progress-chunk media_files"><span>'+wpmdbmf_strings.media_attachments+' (<span class="">'+wpmdb_add_commas(c.determine_progress)+"</span> / "+wpmdb_add_commas(c.attachment_count)+")</span></div>"),b.common.next_step_in_migration={fn:b.functions.media_successfully_determined,args:[c]},b.functions.execute_next_step()}}))},b.functions.media_successfully_determined=function(d){return"undefined"!=typeof d.wpmdb_error&&1===d.wpmdb_error?(b.common.non_fatal_errors+=data.body,b.common.next_step_in_migration={fn:wpmdb_call_next_hook},void b.functions.execute_next_step()):(d.media_progress=0,d.media_progress_image_number=0,d.bottleneck=wpmdb_data.max_request,d.total_files=Object.size(d.files_to_migrate),a(".progress-wrapper-secondary").show(),f(0,0,d.total_files),b.common.next_step_in_migration={fn:c,args:[d]},void b.functions.execute_next_step())},b.functions.finalise_media_migration=function(c){if(1===c.remove_local_media){var d="removing_files_"+wpmdb_migration_type();return a(".progress-text",".progress-wrapper-primary").html(wpmdbmf_strings[d]),c={},c.remove_files=1,c.compare=1,c.offset="",c.next_step_in_migration=!1,b.common.next_step_in_migration={fn:b.functions.remove_files_recursive,args:[c]},void b.functions.execute_next_step()}wpmdb_call_next_hook()},a(document).ready(function(){"savefile"===wpmdb_migration_type()&&a(".media-files-options").hide(),a.wpmdb.add_action("move_connection_info_box",function(){p(b.mediaFiles.remote_media_files_unavailable),wpmdb_toggle_migration_action_text()}),a.wpmdb.add_action("verify_connection_to_remote_site",function(a){b.mediaFiles.remote_connection_data=a,b.mediaFiles.remote_media_files_unavailable="undefined"==typeof a.media_files_available,p(b.mediaFiles.remote_media_files_unavailable)}),a.wpmdb.add_action("wpmdbmst_select_subsite_changed",function(){p(b.mediaFiles.remote_media_files_unavailable)}),a.wpmdb.add_filter("wpmdb_before_migration_complete_hooks",function(a){return!1===g()||"savefile"===wpmdb_migration_type()?a:(a.push(b.functions.prepare_remove_all_files),a)}),a("body").on("change","#mf-select-subsites",function(){a.wpmdb.do_action("wpmdbmf_selected_subsites_changed")}),a("body").on("change","#mf-selected-subsites",function(){a.wpmdb.do_action("wpmdbmf_selected_subsites_changed")}),a.wpmdb.add_filter("wpmdb_migration_profile_ready",h),a.wpmdb.add_action("wpmdb_tables_to_migrate_changed",k),a.wpmdb.add_action("wpmdbmf_selected_subsites_changed",k),a('input[name="media_migration_option"]').change(function(){i()}),i()})}(jQuery,wpmdb);